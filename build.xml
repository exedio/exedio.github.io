<?xml version="1.0"?>

<project name="copeweb" default="build" basedir=".">

	<property file="local.properties" />
	<property name="build.file.tag" value="unlabeled" />
	
	<taskdef name="LoadFile" classname="org.apache.tools.ant.taskdefs.LoadFile" />
	
	<target name="clean">
		<delete dir="build" />
		<delete dir="home/api" />
		<delete dir="home/lib" />
		<delete dir="home/testprotocol.html" />
	</target>
	
	<target name="api">

		<unzip src="lib/exedio-cope.jar-src.zip" dest="build/src" />
		<unzip src="lib/exedio-cops.jar-src.zip" dest="build/src" />
		<unzip src="lib/exedio-cope-util.jar-src.zip" dest="build/src" />

		<property name="api.link.jdk"   value="http://java.sun.com/j2se/1.5.0/docs/api" />
		<property name="api.link.j2ee"  value="http://java.sun.com/j2ee/1.4/docs/api" />
		<property name="api.link.junit" value="http://junit.org/apidocs" />
		<property name="api.link.ant"   value="http://www.dpml.net/api/ant/1.6.5" />

		<javadoc
				destdir="home/api"
				maxmemory="60m"
				source="1.5"
				private="off"
				author="on"
				use="on"
				version="on"
				windowtitle="exedio cope"
				splitindex="on"
				linksource="on"
				failonerror="true"
			>
			<doctitle><![CDATA[Cope with Object Persistence<br>API Specification]]></doctitle>
			<header><![CDATA[<a href="http://cope.sourceforge.net/" target="_top">exedio cope</a>]]></header>
			<footer><![CDATA[Cope with<br>Object<br>Persistence]]></footer>
			<bottom><![CDATA[<a href="http://sourceforge.net/projects/cope"><img src="http://sflogo.sourceforge.net/sflogo.php?group_id=152867&amp;type=12" width="120" height="30" border="0" align="right" alt="Get COPE at SourceForge.net." /></a><small>Copyright &copy; 2004-2009 <a href="http://www.exedio.com/" target="_top">exedio</a> Gesellschaft f&uuml;r Softwareentwicklung mbH. All rights reserved.</small><br><font size="-3">${build.tag}</font>]]></bottom>
			<link href="${api.link.jdk}"   packagelistLoc="package-list/jdk"   offline="true" />
			<link href="${api.link.j2ee}"  packagelistLoc="package-list/j2ee"  offline="true" />
			<link href="${api.link.junit}" packagelistLoc="package-list/junit" offline="true" />
			<link href="${api.link.ant}"   packagelistLoc="package-list/ant"   offline="true" />
			<fileset file="build/src" includes="**/*.java" />
			<classpath>
				<pathelement location="lib/trove.jar" />
				<pathelement location="lib/junit.jar" />
				<pathelement location="${ant.jar}" />
				<pathelement location="lib/bsh-core.jar" />
				<pathelement location="lib/cojen.jar" />
				<pathelement location="lib/servlet-api.jar" />
				<pathelement location="lib/commons-fileupload.jar" />
			</classpath>
			<group title="Cope Persistence Framework" packages="com.exedio.cope:com.exedio.cope.*" />
			<group title="Cope Instrumentor" packages="com.exedio.cope.instrument" />
			<group title="Database Schema Management Facility" packages="com.exedio.dsmf" />
			<group title="Cops Web Framework" packages="com.exedio.cops" />
		</javadoc>
	</target>
	
	
	<target name="lib">
		<copy todir="home/lib">
			<fileset dir="lib">
				<include name="exedio-cope.jar" />
				<include name="exedio-cope-test.jar" />
				<include name="exedio-cope-instrument.jar" />
				<include name="trove.jar" />
				<include name="bsh-core.jar" />
			</fileset>
		</copy>
	</target>

	<target name="testprotocol">
		<java classname="com.exedio.cope.console.EnvironmentCop" taskname="testprotocol"
				fork="yes" failonerror="yes">
			<classpath>
				<pathelement location="lib/exedio-cope.jar" />
				<pathelement location="lib/exedio-cope-console.jar" />
				<pathelement location="lib/trove.jar" />
				<pathelement location="lib/exedio-cops.jar" />
				<pathelement location="lib/servlet-api.jar" />
			</classpath>
			<arg value="build/testprotocol.html"/>
			<assertions><enable/></assertions>
		</java>
		<LoadFile srcFile="build/testprotocol.html" property="testprotocol.html" />
		<copy file="home/testprotocol-template.html"
				tofile="home/testprotocol.html"
				overwrite="true">
			<filterset>
				<filter token="BUILD_TAG" value="${build.tag}" />
				<filter token="TABLE" value="${testprotocol.html}" />
			</filterset>
		</copy>
	</target>
	
	<target name="zip" depends="api, lib, testprotocol">
		<mkdir dir="build" />
		<tar destfile="build/exedio-cope-web.tar.bz2"
			  compression="bzip2">
			<tarfileset dir="${basedir}/home" />
		</tar>
	</target>
	
	<target name="build"
			depends="zip" />
	
	<target name="all" depends="build" />

	<target name="cruise" depends="clean, all">
		<copy todir="${basedir}/cruise">
			<fileset file="${basedir}/build/exedio-cope-web.tar.bz2" />
		</copy>
	</target>
	
</project>
